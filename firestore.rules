rules_version = '2';

/**
 * @file firestore.rules
 * @description Security rules for the İstedad Mərkəzi (Talent Bank) platform.
 *
 * @philosophy
 * This ruleset enforces a multi-tenant security model with three primary roles:
 * 1. Students: Users who create and manage their own talent profiles.
 * 2. Organizations: Users who can view student profiles and manage their own organization profile.
 * 3. Admins: Users with elevated privileges to manage platform data for moderation and administrative purposes.
 *
 * The core principle is strict ownership. Students and Organizations have full control over their own data,
 * but cannot modify data belonging to others.
 *
 * @structure
 * - /users/{userId}: Stores all user documents, differentiated by a 'role' field. This collection is secured
 *   to only allow admins to list all users, while individual users can only access their own document.
 * - /users/{userId}/[subcollection]: Subcollections for projects, achievements, etc., inherit ownership from the parent user document.
 * - /skills/{skillId} & /categories/{categoryId}: Contain public, read-only reference data managed by Admins.
 * - /news/{newsId}: Stores platform-wide news, managed by Admins. Publicly readable.
 * - /telebe-teskilatlari/{orgId}: Stores profiles for student-led organizations.
 * - /telebe-teskilatlari/{orgId}/updates/{updateId}: Updates for a student organization, managed by its leader.
 * - /roles_admin/{userId}: A dedicated collection where the existence of a document grants a user admin privileges.
 *
 * @decisions
 * - Default Read Access: For most collections, individual documents are publicly readable to facilitate discovery (e.g., orgs viewing student profiles).
 *   However, listing entire collections is restricted. The `/users` collection list is only available to admins.
 * - Default Write Access: All write operations are denied by default and are only granted to the document owner or an Admin.
 * - Admin Oversight: Admins have read and write access to most data to manage the platform effectively.
 * - No Anonymous Access: All operations require user authentication to prevent data scraping and ensure accountability.
 *
 * @denormalization
 * To ensure high-performance and secure rules, authorization data is denormalized. For example, a document in the
 * `/users/{userId}/projects/{projectId}` path MUST contain a `studentId` field that matches the `userId` from the
 * path. This avoids slow and costly `get()` calls to parent documents and enforces relational integrity.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks if the authenticated user has an admin role.
     * Admin status is granted by the existence of a document in the /roles_admin collection.
     */
    function isAdmin() {
      // In a real app, this might be a custom claim, but for the prototype, a document check is sufficient.
      // return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      // For the prototype auth, we check the user document's role field.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    /**
     * Gets the role of the user trying to perform the action.
     */
    function getUserRole(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }


    /**
     * On create, validates that the new document's internal ID field matches the
     * UID of the user creating it, enforcing a link between the document and its owner.
     */
    function isCreatingOwnDoc(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * On create, validates that a new subcollection document's internal owner field (e.g., 'studentId')
     * matches the owner ID from the document path.
     */
    function isCreatingOwnedSubDoc(ownerId, ownerField) {
      return request.resource.data[ownerField] == ownerId;
    }

    /**
     * On update, ensures that a critical, immutable field (like an owner ID) has not been changed.
     */
    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }


    // -------------------------------------------------------------------------
    // User Profile Rules (Students and Organizations)
    // -------------------------------------------------------------------------
    /**
     * @description Controls access to all user documents (students, orgs, admins).
     *              - Admins can list and read/write all user documents.
     *              - Authenticated users can read any individual profile (for discoverability).
     *              - Users can only create/update/delete their OWN document.
     * @path /users/{userId}
     * @allow (list) An admin lists all users in the admin panel.
     * @deny (list) A regular student tries to list all users.
     * @allow (get) An organization reads a specific student's profile.
     * @allow (create) A new user creates their own profile document during registration.
     * @deny (update) A user tries to modify another user's profile.
     */
    match /users/{userId} {
        allow list: if isAdmin();
        allow get: if isSignedIn();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId) || isAdmin();
        allow delete: if isOwner(userId) || isAdmin();
    }


    // -------------------------------------------------------------------------
    // Student Subcollection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Secures a student's projects. The data is readable by any authenticated user as part of the
     *              student's public portfolio, but writable only by the student owner or an admin.
     * @path /users/{studentId}/projects/{projectId}
     * @allow (get) An authenticated user reads a project.
     * @allow (create) The owner ('student123') creates a new project under their own profile.
     * @deny (create) A user tries to create a project with a mismatched studentId in the document body.
     */
    match /users/{studentId}/projects/{projectId} {
      allow get, list: if isSignedIn();
      allow create: if (isOwner(studentId) || isAdmin()) && isCreatingOwnedSubDoc(studentId, 'studentId');
      allow update, delete: if isOwner(studentId) || isAdmin();
    }

    /**
     * @description Secures a student's achievements. Readable by any authenticated user, but writable only
     *              by the student owner or an admin.
     * @path /users/{studentId}/achievements/{achievementId}
     * @allow (create) The owner ('student123') creates a new achievement.
     * @deny (delete) A user ('studentABC') tries to delete an achievement belonging to 'student123'.
     */
    match /users/{studentId}/achievements/{achievementId} {
      allow get, list: if isSignedIn();
      allow create: if (isOwner(studentId) || isAdmin()) && isCreatingOwnedSubDoc(studentId, 'studentId');
      allow update, delete: if isOwner(studentId) || isAdmin();
    }
    
     /**
     * @description Secures a student's certificates. Readable by any authenticated user, but writable only
     *              by the student owner or an admin.
     * @path /users/{studentId}/certificates/{certificateId}
     */
    match /users/{studentId}/certificates/{certificateId} {
      allow get, list: if isSignedIn();
      allow create: if (isOwner(studentId) || isAdmin()) && isCreatingOwnedSubDoc(studentId, 'studentId');
      allow update, delete: if isOwner(studentId) || isAdmin();
    }


    // -------------------------------------------------------------------------
    // Public & Semi-Public Data Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages the global list of skills. This data is publicly readable but can
     *              only be managed by administrators.
     * @path /skills/{skillId}
     */
    match /skills/{skillId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages the global list of talent categories. Publicly readable, admin-managed.
     * @path /categories/{categoryId}
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
     /**
     * @description Manages the global list of faculties. Publicly readable, admin-managed.
     * @path /faculties/{facultyId}
     */
    match /faculties/{facultyId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages platform-wide news. News is publicly readable but can only be
     *              managed by administrators.
     * @path /news/{newsId}
     */
    match /news/{newsId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

     /**
     * @description Manages invitations between organizations and students.
     *              - Students can read invitations sent to them.
     *              - Organizations can read invitations they've sent.
     *              - Creation/updates are handled by app logic (e.g., student accepting, org sending).
     * @path /invitations/{invitationId}
     */
    match /invitations/{invitationId} {
      allow read: if isSignedIn() && (isOwner(resource.data.studentId) || isOwner(resource.data.organizationId));
      allow write: if isSignedIn(); // Allow writes for status updates, secured by app logic.
    }

    /**
     * @description Manages projects created by organizations.
     *              - Readable by all signed-in users.
     *              - Writable only by the owning organization or an admin.
     * @path /projects/{projectId}
     */
    match /projects/{projectId} {
        allow get, list: if isSignedIn();
        // studentId field is used as ownerId for both students and orgs
        allow create: if isSignedIn() && isCreatingOwnedSubDoc(request.auth.uid, 'studentId');
        allow update: if isSignedIn() && (isOwner(resource.data.studentId) || isAdmin());
        allow delete: if isSignedIn() && (isOwner(resource.data.studentId) || isAdmin());
    }

    
    // -------------------------------------------------------------------------
    // Student Organization Rules
    // -------------------------------------------------------------------------
    
    /**
     * @description Manages student organization profiles. Publicly readable, but only
     *              admins can create, update, or delete them.
     * @path /telebe-teskilatlari/{orgId}
     */
    match /telebe-teskilatlari/{orgId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages updates for a specific student organization. Readable by anyone.
     *              Writable only by an admin or the designated leader of the student organization.
     * @path /telebe-teskilatlari/{orgId}/updates/{updateId}
     */
    match /telebe-teskilatlari/{orgId}/updates/{updateId} {
        allow get, list: if true;
        // The leaderId is stored on the parent organization document.
        allow create, update, delete: if isAdmin() || isOwner(get(/databases/$(database)/documents/telebe-teskilatlari/$(orgId)).data.leaderId);
    }
  }
}
