/**
 * @fileoverview Firestore Security Rules for İstedad Mərkəzi Platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict, role-based access control (RBAC) model.
 * - 'student' role: Can manage their own data. Can read public profiles.
 * - 'organization' role: Can manage their own data. Can read public profiles.
 * - 'admin' role: Has elevated privileges (to be defined).
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data (students). Document ID MUST match UID. 'role' field determines permissions.
 * - /users/{userId}/(projects|achievements|certificates)/{docId}: User-owned subcollections.
 * - /organizations/{orgId}: Stores organization profile data. Document ID MUST match UID.
 * - /categories/{categoryId}: Publicly readable data.
 * - /faculties/{facultyId}: Publicly readable data.
 *
 * Key Security Decisions:
 * - All writes are gated by checking the user's role and ownership (request.auth.uid == {userId/orgId}).
 * - Public read access is granted to collections like categories and faculties.
 * - Student and Organization profiles are readable by any authenticated user, promoting discoverability.
 * - Creating a user or organization profile requires the document ID to match the user's UID and the correct role to be set.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the UID in the request matches the given userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the user is an admin. Reads the user's role from their profile document.
     */
    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Validates the data for a new student profile.
     */
    function isValidNewStudentData(userId) {
      let data = request.resource.data;
      return isOwner(userId)
          && data.id == userId
          && data.role == 'student';
    }

    /**
     * @description Validates the data for a student profile update.
     */
    function isValidStudentUpdateData() {
        let data = request.resource.data;
        return data.id == resource.data.id
            && data.role == resource.data.role; // Role should not change
    }

    /**
     * @description Security rules for user (student) profiles.
     * @path /users/{userId}
     * @allow (get, list) Any authenticated user can view profiles for search and ranking.
     * @allow (create) A user can create their own profile with the 'student' role.
     * @allow (update) A user can update their own profile.
     * @allow (delete) A user can delete their own profile.
     */
    match /users/{userId} {
      allow get, list: if true;
      allow create: if isValidNewStudentData(userId);
      allow update: if isOwner(userId) && isValidStudentUpdateData();
      allow delete: if isOwner(userId);

      /**
       * @description Security rules for user-owned subcollections.
       * @path /users/{userId}/{subcollection}/{docId}
       * @allow (get, list) Any signed-in user can view subcollection items.
       * @allow (create, update, delete) Only the owner can manage their own items.
       */
      match /{subcollection=**} {
        allow get, list: if isSignedIn();
        allow write: if isOwner(userId);
      }
    }
    
    /**
     * @description Validates the data for a new organization profile.
     */
    function isValidNewOrgData(orgId) {
        let data = request.resource.data;
        return isOwner(orgId)
            && data.id == orgId
            && data.role == 'organization';
    }

    /**
     * @description Validates the data for an organization profile update.
     */
    function isValidOrgUpdateData() {
        let data = request.resource.data;
        return data.id == resource.data.id
            && data.role == resource.data.role; // Role should not change
    }


    /**
     * @description Security rules for organizations.
     * @path /organizations/{organizationId}
     * @allow (get) Any authenticated user can view organization profiles.
     * @allow (list) Listing all organizations is disabled.
     * @allow (create, update, delete) Only the owner can manage their own profile.
     */
    match /organizations/{organizationId} {
      allow get: if isSignedIn();
      allow list: if false; // To be enabled if needed
      allow create: if isValidNewOrgData(organizationId);
      allow update: if isOwner(organizationId) && isValidOrgUpdateData();
      allow delete: if isOwner(organizationId);
    }

    /**
     * @description Security rules for talent categories.
     * @path /categories/{categoryId}
     * @allow (read) Publicly readable by anyone.
     * @allow (write) Writes are disallowed (managed by admin).
     */
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false; 
    }

    /**
     * @description Security rules for faculties.
     * @path /faculties/{facultyId}
     * @allow (read) Publicly readable by anyone.
     * @allow (write) Writes are disallowed (managed by admin).
     */
    match /faculties/{facultyId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
